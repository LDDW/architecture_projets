---
- name: Save the original sshd_config
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.orig
    owner: root
    group: root
    mode: '0644'

- name: Edit sshd_config - Change SSH port
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port '
    line: 'Port 47938'
    state: present
    backup: yes

- name: Edit sshd_config - Disable root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin '
    line: 'PermitRootLogin no'
    state: present
    backup: yes

- name: Edit sshd_config - Enable PubkeyAuthentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PubkeyAuthentication '
    line: 'PubkeyAuthentication yes'
    state: present
    backup: yes

- name: Edit sshd_config - Disable empty passwords
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitEmptyPasswords '
    line: 'PermitEmptyPasswords no'
    state: present
    backup: yes

- name: Edit sshd_config - ClientAliveInterval
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?ClientAliveInterval '
    line: 'ClientAliveInterval 300'
    state: present
    backup: yes

- name: Edit sshd_config - ClientAliveCountMax
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?ClientAliveCountMax '
    line: 'ClientAliveCountMax 2'
    state: present
    backup: yes

- name: Red√©marrer le service sshd
  ansible.builtin.service:
    name: sshd
    state: restarted